---
tags:
  - Каналы
  - Программирование
  - Продуктивность
  - golang
создал заметку: 2025-08-13
---
### Каналы в Go
1. Что такое канал? Чем отличается буферизированный канал от небуферизированного?
   **Канал** — это встроенный тип в Go для **обмена данными между горутинами**. Он гарантирует **безопасную передачу данных** без необходимости вручную синхронизировать доступ.
   
- **Небуферизированный канал** (`make(chan int)`)
    - Передача блокирует **отправителя** до тех пор, пока получатель не прочитает данные.
    - И наоборот — получатель ждёт, пока кто-то запишет данные.
    - Хорошо подходит для синхронизации.
    Обязательным условием является одновременное наличие **и читателя, и писателя**
- **Буферизированный канал** (`make(chan int, 5)`)
    - Имеет очередь фиксированного размера.
    - Отправка блокируется только тогда, когда буфер заполнен.
    - Чтение блокируется, если буфер пуст.
    - Подходит, если нужно сгладить разницу в скорости работы горутин.
	``` go
	type hchan struct {
	    qcount   uint           // количество элементов в буфере
	    dataqsiz uint           // размер буфера (ёмкость)
	    buf      unsafe.Pointer // указатель на массив данных (буфер)
	    elemsize uint16         // размер одного элемента
	    closed   uint32         // флаг закрытия канала
	    elemtype *_type         // информация о типе элементов (runtime type)
	    sendx    uint           // индекс для следующей записи (в буфере)
	    recvx    uint           // индекс для следующего чтения (в буфере)
	    recvq    waitq          // очередь горутин, ожидающих чтение
	    sendq    waitq          // очередь горутин, ожидающих запись
	    lock     mutex          // мьютекс для синхронизации доступа
	}
	```
	- **qcount** — сколько элементов сейчас в канале.
	- **dataqsiz** — максимальный размер буфера.
	- **buf** — указатель на сам буфер (массив), если канал буферизированный.
	- **elemsize** — размер одного элемента в байтах (для копирования в буфер).
	- **closed** — признак, закрыт ли канал (`0` или `1`).
	- **elemtype** — информация о типе элементов (нужно для правильного копирования).
	- **sendx / recvx** — индексы для циклической записи/чтения в буфер.
	- **recvq / sendq** — очереди горутин, которые ждут возможности прочитать или записать.
	- **lock** — внутренний `мьютекс`, защищающий всю структуру от одновременного доступа.
2. Как создать канал? Как закрыть канал?
	``` go
	// Создание небуферизированного канала
	ch := make(chan int)
	
	// Создание буферизированного канала с размером 3
	ch := make(chan int, 3)
	
	// Закрытие канала
	close(ch)
	```
3. Как читать из канала и писать в канал?
	``` go
	// Запись
	ch <- 42
	
	// Чтение
	val := <-ch
	
	// Чтение с проверкой, закрыт ли канал
	val, ok := <-ch // ok == false, если канал закрыт
	```
4. Зачем нужны в целом каналы?
   - Безопасная передача данных между горутинами без явных блокировок (`mutex` и т.п.).
   - Синхронизация выполнения (ждать события, передать сигнал).
   - Организация потоков обработки данных (**pipeline**).
   Go-философия: _"Не делитесь памятью, общайтесь через каналы"_.
5. Что будет, если читать из закрытого канала?
   - Можно читать до тех пор, пока не заберёшь все данные из буфера. 
   - После того как буфер пуст, чтение возвращает **нулевое значение типа** (например, `0` для `int`) и `ok == false`.
   - Чтение не паникует.
6. Что будет, если писать в закрытый канал?
   Паника
	```
   panic: send on closed channel
	```
7. Что будет если закрыть закрытый канал?
   Паника.
	```
	panic: close of closed channel
	```
8. Что такое nil канал и что будет если писать и читать от туда?
   - **Писать** в nil-канал — блокировка навсегда (deadlock). Никогда не выполнится условие, которое необходимо для продолжения работы.
   - **Читать** из nil-канала — тоже блокировка навсегда.
   - **Закрыть** nil-канал — panic.
	``` go
	var ch chan int // ch == nil

	ch = make(chan int, 3)
	for {
		v, ok := <-ch
		fmt.Println(v, ok)
		if !ok {
			break
		} 
	}
	for num := range ch {
		fmt.Println(num)
	}
	```
![[Pasted image 20250813132003.png]]
Закрываем канал там, где пишутся данные
![[Pasted image 20250813132051.png]]
![[Pasted image 20250813132138.png]]
